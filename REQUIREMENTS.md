# KomaSync 要件定義（現行実装準拠）

## 1. 目的 / スコープ
- 日本のアニメ制作で用いられる縦タイムシート（24FPS）に合わせ、セリフ録音・取り込み・編集・確認をブラウザ内で完結させる。
- タイムシート上での再生・スクラブ・範囲編集・VAD（セリフ検出）表示・書き出しを対象とする。
- 永続保存やクラウド連携は行わない（リロード/リセットで消失）。

## 2. 前提 / 動作環境
- ブラウザ（Web Audio API / MediaRecorder / WebAssembly を使用）。
- マイク録音は安全なオリジンが必須（HTTPS または `localhost`）。
- Silero VAD を Web Worker + `onnxruntime-web`（WASM）で実行。失敗時は簡易 VAD にフォールバック。
- 本番では `coi-serviceworker.js` を登録し、COOP/COEP 付与で crossOriginIsolated を目指す。
- ネットワーク不要（音声処理はローカルのみ）。

## 3. 用語 / 単位
- `FPS`: 24。
- 1列（Column）: 3秒 = 72コマ。
- 1シート: 2列 = 6秒 = 144コマ。
- フレーム番号: 0-based 内部管理。表示は 1-based を混在（詳細は表示仕様）。
- タイムコード表記: `秒+コマ`（例: `12+03`）。

## 4. 初期状態
- トラック: 3本固定。`Track 1` / `Track 2` / `Track 3`。
- 色テーマ: Track 1 = 青 / Track 2 = 赤 / Track 3 = 緑（UIアクセント）。
- `recordTrackId` = `1`（録音/アップロード対象）。
- `editTarget` = `1`（編集対象）。
- `recordingState` = `IDLE`。
- `currentFrame` = 0。
- `sheetZoom` = 1（100%）。
- VAD: 自動調整 ON、プリセット `normal`、安定度 0.4、感度スケール 1。
- クリップボード空 / Undo・Redo 履歴空。

## 5. 画面構成 / レイアウト
### 5.1 AppShell
- 3分割構成。
  - 上部: TopBar（固定高さ）。
  - 中央: タイムシート表示（スクロール領域）。
  - 下部: TransportDock（固定高さ）。
- 高さは `--app-height` を使用（`visualViewport.height` 優先）。
- safe-area（iOS）対応: 上下に `env(safe-area-inset-*)` を反映。

### 5.2 TopBar（上部バー）
- 配色: `bg-indigo-600` / 文字白 / 下枠 `indigo-700`。
- 左側: リセットボタン、アプリ名、シート番号、合計タイムコード、選択範囲タイムコード。
- 右側: ズームアウト / 全体表示 / ズームイン、Undo、Redo、ミュートメニュー、ヘルプ、その他。
- ミュートアイコン: いずれかのトラックがミュートなら `VolumeX`（色: amber 系）。
- リセットは録音/処理中は無効。
- タイムコード表示: `totalTimecode`（最大フレーム数）を表示し、選択範囲がある場合は ` / 選 {selectionTimecode}` を併記。
- シート番号は `currentFrame` を基に 1 始まりで表示。

### 5.3 TimesheetViewport（中央ビュー）
- 背景: `bg-gray-100`。
- 横スクロールでシート移動。ズーム時は縦スクロールも発生。
- 列単位で `snap`。可視列 + 前後2列の仮想レンダリング。
- ルーラー左右 + トラック列のグリッド。

### 5.4 TransportDock（下部ドック）
- 背景: 白、上枠 `border-gray-200`。
- ボタン群: 録音 / 再生 / 全トラック / -1f / +1f。
- 録音ボタンには状態表示（テキスト + 点灯ドット + `REC T{recordTrackId}`）。
- 再生ボタンは録音中・処理中は無効。
- `全` ボタンは `editTarget=all` のときアクティブ。
- `+1f` / `-1f` は再生中・録音中・処理中は無効。
- 録音状態のテキスト: `録音` / `準備中…` / `処理中…` / `停止`（録音中）。
- 録音インジケータ色: 録音中=赤 / 準備中=黄 / 準備済み=緑 / 未準備=灰。

### 5.5 オーバーレイ
- `EditPalette`（選択メニュー）: 選択範囲があるときのみ表示。右クリック/長押しで表示。
- `TrackMuteMenu`（ミュートメニュー）: TopBar のミュートボタンから表示。
- `MoreSheet` / `HelpSheet`: 画面下からのボトムシート。背景は半透明黒でモーダル。

## 6. UIデザイン詳細
### 6.1 サイズ / タイポグラフィ
- CSS 変数で UI スケールを管理 (`--control-size`, `--record-h`, `--ui-sm`, `--ui-xs`)。
- フォント: `font-sans`（UI）/ `font-mono`（タイムコード・ルーラー）。
- モバイルではフォント/ボタンサイズ拡大。極小幅では TopBar 高さが2段相当に増える。

### 6.2 タイムシートのグリッド表現
- 1列あたり 72行（3秒）で縦配置。
- 左ルーラー: シート内コマ数（1〜72）。
- 右ルーラー: 総コマ数（1-based）、ただし現在行のみ `秒+コマ` 表示。
- ルーラーの表示密度はズームに応じて自動間引き（行高が低いと 1/6/12 コマ刻み、現在行は常に表示）。
- 罫線の強さ:
  - 1秒境界: 太線。
  - 0.5秒境界: 中線。
  - 6コマ境界: 細線。
  - その他: 最細線。
- 現在フレーム行は黄色背景。
- 選択範囲は水色背景 + 二重アウトライン。
- トラック枠はアクティブトラックにアクセント枠を追加。
- 音声末尾境界は赤線で表示。
- 最大フレーム数を超えたセルは薄いグレーで塗り、再生ヘッドは通常表示。

### 6.3 波形 / セリフラベル
- 波形は各トラック内で RMS を正規化して描画。
- 波形は細い縦線の連なりで表現し、中央にハイライト線。
- セリフラベルは縦長の色付きバーをセル中央に描画（トラック色準拠）。

### 6.4 メニュー UI
- `EditPalette`: 青系のカード。切り取り/削除、セリフラベル操作、クリップボード操作を配置。
- `TrackMuteMenu`: 白いポップオーバー、トラックごとのミュート切替、色ドット表示。
- `MoreSheet`: 書き出し・アップロード・VAD設定（入力レベル/診断/詳細設定）・録音設定・バージョン表示。
- `HelpSheet`: 機能説明、操作方法、ショートカットを文章で表示。

## 7. データモデル
### 7.1 Track
- `id`: 文字列（`1`/`2`/`3`）。
- `name`: トラック名。
- `audioBuffer`: `AudioBuffer | null`。
- `frames`: `FrameData[]`（フレーム単位の解析結果）。
- `speechOverrides`: `number[]`（1=セリフ固定、0=自動、-1=非セリフ固定）。
- `isMuted`: ミュート状態。
- `isVisible`: 実装上保持だが UI では未使用。

### 7.2 FrameData
- `frameIndex`: 0-based。
- `time`: 秒。
- `volume`: RMS。
- `isSpeech`: 自動判定結果。

### 7.3 クリップボード
- `kind`: `single` / `all`。
- `byTrackId`: `Record<string, AudioBuffer>`。
- `speechOverridesByTrackId`: `Record<string, number[]>`。
- OS クリップボードとは無関係（内部のみ）。

## 8. タイムシート表示仕様
- 列幅はビューポート幅の1/2を基準（ズーム倍率で拡大）。
- 行高はビューポート高さを 72分割した値を基準（ズーム倍率で拡大）。
- ルーラー幅は列幅の25%を基準（36〜56px にクランプ）。
- 表示対象列は `currentFrame` を含むよう仮想的に拡張。
- ズーム中は再生ヘッドが見えるように自動追従スクロール。
- ズーム無し（100%）ではシート境界（6秒）ごとに自動スクロール。
- 自動スクロールは再生中/録音中のみ有効。
- ズーム範囲: 1.0〜3.0、ステップ 0.1（内部は小数2桁で正規化）。

## 9. 基本操作
### 9.1 フレーム移動
- トラックセルまたはルーラーをタップ/クリックで再生ヘッド移動。
- 再生中はフレーム移動操作で一時停止。

### 9.2 スクラブ再生
- ルーラーをドラッグでスクラブ。
- タッチ時は現在フレーム行からのドラッグでもスクラブ可能。
- キーボード `↑/↓` で 1フレーム単位スクラブ。
- スクラブプレビュー: 1回 0.08秒 / フェード 0.01秒 / 50ms スロットリング。
- プレビューはミュートされていないトラックのみ再生（範囲選択中のスクラブは単一トラック時のみ対象トラックを再生）。

### 9.3 範囲選択
- PC: ドラッグで範囲選択。
- タッチ: タップで1コマ選択、タップ長押し or ドラッグで範囲選択。
- 選択は `editTarget` が `all` の場合全トラックに適用、単一トラックの場合はそのトラックにのみ表示。
- 選択範囲外をクリックすると選択解除。
- 選択範囲の長さは `startFrame`〜`endFrame` を両端含みで計算。
- PC のクリックのみでは選択は作成せず、フレーム移動のみ行う。

### 9.4 コンテキストメニュー
- 右クリック（PC）または長押し（タッチ）で `EditPalette` を表示。
- メニュー表示時、選択範囲が無い場合は対象フレームを自動選択。

### 9.5 トラック選択 / 編集対象
- セルをタップ/クリックすると、そのトラックが編集対象（`editTarget`）になり録音対象も追従。
- `全` ボタンで編集対象を `all` に切替（再度押すと最後の単一トラックへ復帰）。
- `all` 選択中も録音対象は直近の単一トラックを保持する。

### 9.6 ズーム / スクロール
- TopBar の `ズームアウト/全体表示/ズームイン` で倍率変更。
- タッチではピンチ操作でズーム可能。
- ズーム中はピンチで拡大縮小、2本指移動でパン。
- 非ズーム時は横スクロールでシート移動、ズーム時は縦横スクロールで範囲移動。

### 9.7 リセット
- TopBar のリセットで確認ダイアログを表示。
- 実行時は再生/録音/スクラブ/VUメーター/マイクを停止し、全状態を初期化。
- トラック/履歴/選択/クリップボード/編集対象/録音対象/フレーム位置は初期値に戻る。

## 10. 再生
- `PLAY` ボタンで `currentFrame` から再生開始。
- 再生中は `PAUSE` ボタンで一時停止。
- 再生は最長トラックの終端で自動停止し `IDLE` に戻る。
- 末尾到達時に再生を開始すると `currentFrame` は 0 に戻る。
- ミュートは即時反映（再生中も gain を更新）。
- 再生は全トラックをミックスして出力（ミュートトラックは無音）。

## 11. 録音
### 11.1 録音準備
- 録音開始時にマイク許可を取得。
- 取得済みストリームは保持し、5分無操作で自動停止。
- 初回操作時にウォームアップでマイク準備を試行。
- 無操作判定は 15 秒間隔で監視し、録音中/処理中はスリープしない。

### 11.2 録音開始 / 停止
- 録音開始位置は `currentFrame`。
- 録音は `recordTrackId` に対して上書き挿入。
- 録音中は録音ボタンが `停止` 表示。
- 録音停止後は `PROCESSING` 表示となり、処理完了後に `IDLE`。
- 200ms 未満の録音は破棄。
- `MediaRecorder` の対応 MIME を自動選択（`webm/opus` → `webm` → `mp4` → `ogg/opus` → `aac`）。
- 既存トラックのサンプルレートと一致しない場合は読み込みエラー扱い。

### 11.3 録音中再生
- `playWhileRecording` が ON の場合、録音開始と同時に既存トラックを再生。
- OFF の場合はフレームカウンタのみ進行（再生なし）。

## 12. 編集機能
### 12.1 切り取り（Cut）
- 選択範囲を切り取り、該当区間は無音で埋める（長さ維持）。
- クリップボードに AudioBuffer + セリフラベルを保存。
- `editTarget=all` の場合は全トラック分を保持。

### 12.2 削除（Delete）
- 選択範囲を削除し、後続を前詰め（リップル）。
- `currentFrame` を選択開始位置に移動。

### 12.3 貼り付け（挿入 / 上書き）
- 挿入: 現在フレームにクリップを挿入し後続を後ろへ。
- 上書き: 現在フレームにクリップを上書き。
- `editTarget=all` の場合、`kind=all` のクリップ必須。
- クリップボードがある場合、`EditPalette` から消去可能。

### 12.4 +1f / -1f
- `+1f`: 現在フレーム位置に無音を1フレーム挿入。
- `-1f`: 現在フレームを削除して詰める。

### 12.5 セリフラベル操作
- `セリフ`: 選択範囲を強制セリフ。
- `解除`: 選択範囲を強制非セリフ。
- `自動`: 選択範囲を自動判定に戻す。
- 手動ラベルは VAD より優先。
- 編集操作は再生中の場合は自動で一時停止する。
- 録音中/処理中は編集操作を受け付けない。
- 編集に伴い `speechOverrides` は範囲に合わせて挿入/削除/上書きされる。

### 12.6 Undo / Redo
- 履歴対象: トラック状態の変更（audioBuffer/frames/speechOverrides/ミュート等）と VAD 感度変更（手動時）。
- トラック履歴の Undo/Redo は `frames` を空で復元後に VAD を再解析し、選択を解除する。
- VAD 感度履歴の Undo/Redo は感度のみ変更し、選択は維持される。
- クリップボードは保持される。

## 13. VAD（セリフ検出）
### 13.1 エンジン
- デフォルト: Silero VAD（ONNX）を Web Worker で実行。
- 失敗時: RMS 閾値型の簡易 VAD にフォールバック。
- エンジン状態とエラーは `MoreSheet` で表示。

### 13.2 自動調整
- 自動 ON のとき、録音が 6フレーム以上あるトラックから統計を取り調整。
- 調整対象: 感度スケール / 途切れにくさ。
- 自動中は詳細設定を変更不可。
- 対象トラックは「音声があり、かつ VAD フレームに非ゼロ音量が含まれるもの」。
- 音声バッファが更新されたときのみ再調整。

### 13.3 手動調整
- 感度（50〜150%）、途切れにくさ（0〜100%）、環境プリセット（静か/普通/騒がしい）。
- 手動変更は `Undo/Redo` 対象（感度のみ）。

### 13.4 判定ルール概要
- フレームごとの RMS を計算。
- Silero VAD の確率をフレーム単位に集約し、開始/終了閾値 + ヒステリシス + hold フレームで連続性を担保。
- VAD 設定変更時は全トラックを再解析し、`frames` と `speechOverrides` 長を更新。

### 13.5 実装パラメータ（VAD）
- Silero 解析は 16kHz にリサンプルし、`512` サンプル窓 / `320` サンプルステップで確率を取得。
- 確率のノイズ床は 0.2 分位を参照し、閾値の自動補正に使用。
- RMS フォールバックの基準閾値（プリセット）: quiet=0.035 / normal=0.05 / noisy=0.08。

## 14. インポート / エクスポート
### 14.1 インポート
- `MoreSheet` のアップロードから `recordTrackId` に読み込み。
- 読み込み位置はフレーム 0（先頭）。

### 14.2 音声エクスポート
- トラック別 WAV を ZIP 化。
- WAV は 16-bit PCM。最長トラックに合わせて無音パディング。
- ファイル名はトラック名を英数字 + `_` に正規化。
- ZIP 名: `komasync_audio_YYYY-MM-DDTHH-MM-SS.zip`。

### 14.3 シート画像エクスポート
- PNG を ZIP 化。
- `表示中` は現在の先頭列に対応するシートを出力。
- `全シート` は全シートを出力。
- 画像内レイアウトはタイムシート構造（2列/72行/トラック数）を再現。
- ZIP 名: `komasync_sheets_YYYY-MM-DDTHH-MM-SS.zip`。
- シート番号は 1 始まり、`sheet_001.png` 形式で連番出力。
- `表示中` のシート判定は「最左可視列 ÷ 2」で算出する。
- 画像出力の基本設定: scale=2 / margin=16 / header=44 / footer=24 / rowHeight=12 / rulerWidth=60 / trackWidth=70 / VAD α=0.28。

## 15. ショートカット
- `Ctrl/Cmd + Z`: Undo
- `Ctrl/Cmd + Y` / `Shift + Ctrl/Cmd + Z`: Redo
- `Ctrl/Cmd + X`: Cut
- `Ctrl/Cmd + V`: Paste（Shiftで上書き）
- `↑/↓`: Scrub（1フレーム移動 + プレビュー）
- `HelpSheet` / `MoreSheet` 表示中は矢印スクラブを無効化。

## 16. エラー / 通知
- マイク未接続・許可拒否・使用中は個別メッセージで通知。
- 録音が短すぎる場合は破棄。
- デコード失敗時はアラート表示。
- エクスポート対象が無い場合はエラー表示。
- Cut/Paste の整合性が取れない場合はアラート（全トラック貼り付け条件不一致など）。

## 17. 非機能要件
- 状態はメモリのみ。リロード/リセットで消失。
- Undo/Redo は最大 30 ステップ。
- レンダリングは列単位の仮想化で負荷を抑制。
- オーディオ処理はすべてクライアント内完結。
